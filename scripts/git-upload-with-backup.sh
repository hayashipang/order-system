#!/bin/bash

# Git ä¸Šå‚³å‰é›²ç«¯å‚™ä»½è…³æœ¬
# ç¢ºä¿æ¯æ¬¡ä¸Šå‚³åˆ° git å‰éƒ½æœƒå…ˆå‚™ä»½é›²ç«¯è³‡æ–™

echo "ğŸš€ é–‹å§‹ Git ä¸Šå‚³æµç¨‹ï¼ˆå«é›²ç«¯å‚™ä»½ï¼‰"
echo "=================================="

# æª¢æŸ¥ç•¶å‰ç›®éŒ„
if [ ! -f "package.json" ]; then
    echo "âŒ éŒ¯èª¤ï¼šè«‹åœ¨é …ç›®æ ¹ç›®éŒ„åŸ·è¡Œæ­¤è…³æœ¬"
    exit 1
fi

# ç¬¬ä¸€æ­¥ï¼šå‚™ä»½é›²ç«¯è³‡æ–™
echo ""
echo "ğŸ“‹ ç¬¬ä¸€æ­¥ï¼šå‚™ä»½é›²ç«¯è³‡æ–™"
echo "======================"
./scripts/backup-cloud-data.sh

if [ $? -ne 0 ]; then
    echo "âŒ é›²ç«¯å‚™ä»½å¤±æ•—ï¼Œåœæ­¢ä¸Šå‚³æµç¨‹"
    exit 1
fi

echo ""
echo "ğŸ“‹ ç¬¬äºŒæ­¥ï¼šæª¢æŸ¥ Git ç‹€æ…‹"
echo "======================"

# æª¢æŸ¥æ˜¯å¦æœ‰æœªæäº¤çš„æ›´æ”¹
if [ -z "$(git status --porcelain)" ]; then
    echo "â„¹ï¸  æ²’æœ‰æœªæäº¤çš„æ›´æ”¹"
    echo "âœ… Git ç‹€æ…‹æ­£å¸¸ï¼Œç„¡éœ€ä¸Šå‚³"
    exit 0
fi

# é¡¯ç¤ºå°‡è¦æäº¤çš„æ–‡ä»¶
echo "ğŸ“ å°‡è¦æäº¤çš„æ–‡ä»¶ï¼š"
git status --short

echo ""
echo "ğŸ“‹ ç¬¬ä¸‰æ­¥ï¼šGit æäº¤å’Œæ¨é€"
echo "========================"

# æ·»åŠ æ‰€æœ‰æ›´æ”¹
echo "ğŸ”„ æ·»åŠ æ–‡ä»¶åˆ°æš«å­˜å€..."
git add .

# æäº¤æ›´æ”¹
echo "ğŸ’¾ æäº¤æ›´æ”¹..."
read -p "è«‹è¼¸å…¥æäº¤è¨Šæ¯ (æˆ–æŒ‰ Enter ä½¿ç”¨é è¨­è¨Šæ¯): " commit_message

if [ -z "$commit_message" ]; then
    commit_message="feat: æ›´æ–°ç³»çµ±åŠŸèƒ½å’Œé…ç½®"
fi

git commit -m "$commit_message"

if [ $? -ne 0 ]; then
    echo "âŒ Git æäº¤å¤±æ•—"
    exit 1
fi

# æ¨é€åˆ°é ç«¯
echo "ğŸš€ æ¨é€åˆ°é ç«¯å€‰åº«..."
git push origin main

if [ $? -eq 0 ]; then
    echo ""
    echo "ğŸ‰ Git ä¸Šå‚³å®Œæˆï¼"
    echo "=================="
    echo "âœ… é›²ç«¯è³‡æ–™å·²å‚™ä»½"
    echo "âœ… ç¨‹å¼ç¢¼å·²ä¸Šå‚³åˆ° Git"
    echo "âœ… å¯ä»¥å®‰å…¨åœ°éƒ¨ç½²åˆ°é›²ç«¯"
    echo ""
    echo "ğŸ“‹ å‚™ä»½æª”æ¡ˆä½ç½®ï¼š"
    echo "  - cloud_data_backups/ ç›®éŒ„"
    echo "  - æœ€æ–°å‚™ä»½ï¼š$(ls -t cloud_data_backups/complete_backup_*.json | head -1)"
else
    echo "âŒ Git æ¨é€å¤±æ•—"
    exit 1
fi
